{% extends 'base.html' %}

{% block title %}Карта кладбища{% endblock %}

{% block extra_css %}
<style>
    /* Дополнительные стили для страницы с картой */
    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .map-container {
        position: relative;
    }
    
    #search-panel {
        margin-bottom: 20px;
    }
    
    .compact-form .form-group {
        margin-bottom: 0.5rem;
    }
    
    .compact-form label {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-3">Интерактивная карта кладбища</h1>
        
        <div class="form-group mb-3">
            <label for="cemetery-selector">Выберите кладбище:</label>
            <select id="cemetery-selector" class="form-control">
                {% for cem in cemeteries %}
                <option value="{{ cem.id }}" data-lat="{{ cem.latitude }}" data-lng="{{ cem.longitude }}" {% if cem.id == cemetery.id %}selected{% endif %}>
                    {{ cem.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-3">
        <!-- Боковая панель поиска -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Поиск захоронений</h5>
                <form id="search-form" class="compact-form">
                    <div class="form-group">
                        <label for="id_query">{{ search_form.query.label }}</label>
                        {{ search_form.query }}
                    </div>

                    <div class="form-group">
                        <label for="id_birth_date_from">{{ search_form.birth_date_from.label }}</label>
                        {{ search_form.birth_date_from }}
                    </div>

                    <div class="form-group">
                        <label for="id_birth_date_to">{{ search_form.birth_date_to.label }}</label>
                        {{ search_form.birth_date_to }}
                    </div>

                    <div class="form-group">
                        <label for="id_death_date_from">{{ search_form.death_date_from.label }}</label>
                        {{ search_form.death_date_from }}
                    </div>

                    <div class="form-group">
                        <label for="id_death_date_to">{{ search_form.death_date_to.label }}</label>
                        {{ search_form.death_date_to }}
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            {{ search_form.favorites_only }}
                            <label class="form-check-label" for="id_favorites_only">
                                {{ search_form.favorites_only.label }}
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Поиск</button>
                </form>
            </div>
        </div>
        
        <div id="search-results" class="mt-3">
            <!-- Здесь будут результаты поиска -->
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="map-container">
            <div id="map" style="height: 70vh;"></div>
            
            <div class="map-controls">
                <button id="get-location" class="btn btn-primary" onclick="getCurrentLocation()">
                    <i class="fas fa-map-marker-alt"></i> Мое местоположение
                </button>
                
                {% if user.is_authenticated %}
                <button class="btn btn-success ml-2" id="add-burial-button">
                    <i class="fas fa-plus"></i> Предложить захоронение
                </button>
                {% endif %}
                
                {% if user.is_staff %}
                <button class="btn btn-danger ml-2" id="admin-add-burial-button">
                    <i class="fas fa-plus"></i> Добавить захоронение (admin)
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления захоронения пользователем -->
{% if user.is_authenticated %}
<div id="add-burial-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Предложить новое захоронение</h3>
        <p>Отметьте точку на карте или используйте свое текущее местоположение, затем заполните информацию о захоронении.</p>
        
        <form id="add-burial-form" onsubmit="return submitBurialRequest(this)">
            <div class="form-group">
                <label for="id_full_name">ФИО похороненного человека*</label>
                <input type="text" class="form-control" id="id_full_name" name="full_name" required>
            </div>
            
            <div class="form-group">
                <label for="id_birth_date">Дата рождения</label>
                <input type="date" class="form-control" id="id_birth_date" name="birth_date">
            </div>
            
            <div class="form-group">
                <label for="id_death_date">Дата смерти</label>
                <input type="date" class="form-control" id="id_death_date" name="death_date">
            </div>
            
            <div class="form-group">
                <label for="id_description">Описание</label>
                <textarea class="form-control" id="id_description" name="description" rows="3"></textarea>
            </div>
            
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            
            <div class="text-right">
                <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('add-burial-modal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Отправить</button>
            </div>
        </form>
        <div class="mt-3">
            <small class="text-muted">* - обязательные поля</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно для добавления захоронения администратором -->
{% if user.is_staff %}
<div id="admin-add-burial-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Добавить новое захоронение</h3>
        <p>Отметьте точку на карте, затем заполните информацию о захоронении.</p>
        
        <form id="admin-add-burial-form" onsubmit="return addBurial(this)">
            <div class="form-group">
                <label for="admin_full_name">ФИО похороненного человека*</label>
                <input type="text" class="form-control" id="admin_full_name" name="full_name" required>
            </div>
            
            <div class="form-group">
                <label for="admin_birth_date">Дата рождения</label>
                <input type="date" class="form-control" id="admin_birth_date" name="birth_date">
            </div>
            
            <div class="form-group">
                <label for="admin_death_date">Дата смерти</label>
                <input type="date" class="form-control" id="admin_death_date" name="death_date">
            </div>
            
            <div class="form-group">
                <label for="admin_description">Описание</label>
                <textarea class="form-control" id="admin_description" name="admin_description" rows="3"></textarea>
            </div>
            
            <input type="hidden" id="admin-latitude" name="latitude">
            <input type="hidden" id="admin-longitude" name="longitude">
            
            <div class="text-right">
                <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('admin-add-burial-modal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
        </form>
        <div class="mt-3">
            <small class="text-muted">* - обязательные поля</small>
        </div>
    </div>
</div>
{% endif %}

{% if user.is_staff %}
<div id="admin-mode" style="display: none;"></div>
{% endif %}

{% if user.is_authenticated %}
<div id="add-burial-mode" style="display: none;"></div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Яндекс Карты API -->
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
<script src="/static/js/map.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация карты
        initMap({{ cemetery.latitude }}, {{ cemetery.longitude }}, '{{ yandex_maps_api_key }}');
        
        // Стилизация элементов формы поиска
        const queryInput = document.getElementById('id_query');
        if (queryInput) {
            queryInput.className = 'form-control';
            queryInput.placeholder = 'Введите ФИО';
        }
        
        const birthDateFrom = document.getElementById('id_birth_date_from');
        if (birthDateFrom) {
            birthDateFrom.className = 'form-control';
        }
        
        const birthDateTo = document.getElementById('id_birth_date_to');
        if (birthDateTo) {
            birthDateTo.className = 'form-control';
        }
        
        const deathDateFrom = document.getElementById('id_death_date_from');
        if (deathDateFrom) {
            deathDateFrom.className = 'form-control';
        }
        
        const deathDateTo = document.getElementById('id_death_date_to');
        if (deathDateTo) {
            deathDateTo.className = 'form-control';
        }
        
        const favoritesOnly = document.getElementById('id_favorites_only');
        if (favoritesOnly) {
            favoritesOnly.className = 'form-check-input';
        }
        
        // Обработчик для выбора кладбища
        const cemeterySelector = document.getElementById('cemetery-selector');
        if (cemeterySelector) {
            cemeterySelector.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const latitude = parseFloat(selectedOption.getAttribute('data-lat'));
                const longitude = parseFloat(selectedOption.getAttribute('data-lng'));
                const cemeteryId = this.value;
                
                // Центрирование карты на новых координатах
                if (window.myMap) {
                    window.myMap.setCenter([latitude, longitude], 15);
                    
                    // Загружаем захоронения для выбранного кладбища
                    loadBurials(cemeteryId);
                }
                
                // Обновляем URL с новым выбранным кладбищем
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('cemetery_id', cemeteryId);
                window.history.pushState({}, '', currentUrl.toString());
            });
        }
        
        // Обработчики для модальных окон
        const addBurialButton = document.getElementById('add-burial-button');
        if (addBurialButton) {
            addBurialButton.addEventListener('click', function() {
                // Показать модальное окно для пользователя
                const modal = document.getElementById('add-burial-modal');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // Добавляем кладбище в форму
                    const cemeteryId = document.getElementById('cemetery-selector').value;
                    const hiddenCemeteryInput = document.createElement('input');
                    hiddenCemeteryInput.type = 'hidden';
                    hiddenCemeteryInput.name = 'cemetery_id';
                    hiddenCemeteryInput.value = cemeteryId;
                    document.getElementById('add-burial-form').appendChild(hiddenCemeteryInput);
                }
            });
        }
        
        const adminAddBurialButton = document.getElementById('admin-add-burial-button');
        if (adminAddBurialButton) {
            adminAddBurialButton.addEventListener('click', function() {
                // Показать модальное окно для администратора
                const modal = document.getElementById('admin-add-burial-modal');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // Добавляем кладбище в форму
                    const cemeteryId = document.getElementById('cemetery-selector').value;
                    const hiddenCemeteryInput = document.createElement('input');
                    hiddenCemeteryInput.type = 'hidden';
                    hiddenCemeteryInput.name = 'cemetery_id';
                    hiddenCemeteryInput.value = cemeteryId;
                    document.getElementById('admin-add-burial-form').appendChild(hiddenCemeteryInput);
                }
            });
        }
        
        // Закрытие модальных окон
        const closeButtons = document.getElementsByClassName('close-modal');
        for (let i = 0; i < closeButtons.length; i++) {
            closeButtons[i].addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}
